<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì§€êµ¬ëŠ” ë‚´ ê±°ì•¼!</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background-image: url('background.png');
      background-size: cover;            /* í™”ë©´ì„ ê½‰ ì±„ì›€ */
      background-position: center;       /* ê°€ìš´ë° ì •ë ¬ */
      background-repeat: no-repeat;      /* ë°˜ë³µí•˜ì§€ ì•ŠìŒ */
      background-attachment: fixed;      /* ìŠ¤í¬ë¡¤í•´ë„ ê³ ì •ëœ ë°°ê²½ (ì„ íƒ) */
      margin: 0;
  padding: 0;
  height: 100%;
  overflow: auto;
}
    #startScreen {
      padding: 20px;
    }
  
#gameContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  overflow-y: auto; /* ì ìˆ˜íŒë§Œ ìŠ¤í¬ë¡¤ë¨ */
}

#mainArea {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  height: 100vh; /* ì „ì²´ í™”ë©´ ë†’ì´ */
  box-sizing: border-box;
  overflow: hidden;
}

#grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: repeat(10, 1fr);
  gap: 2px;
  width: 100vw;
  height: 90vh; /* í™”ë©´ì˜ 90%ë§Œ ì‚¬ìš©í•´ì„œ ê²©ìíŒ í‘œì‹œ */
  box-sizing: border-box;
}

.cell {
  background: #eee;
  border: 1px solid #999;
  font-size: 1.8vmin;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 4px;
  word-break: break-word;
  text-align: center;
  box-sizing: border-box;
  height: 100%;   /* ê° ì…€ì˜ ë†’ì´ëŠ” ìë™ìœ¼ë¡œ ê²°ì •ë¨ */
  width: 100%;
}

#scorePanel {
  flex-shrink: 0;
  width: 100%;
  display: flex !important;
  flex-direction: column;
  overflow-x: auto;
  padding: 20px;
  box-sizing: border-box;
  background-color: white; /* ë°°ê²½ í°ìƒ‰ */
  border-radius: 8px;
  text-align: center;
  user-select: none;
  border-top: 4px solid #999;
  border-bottom: 4px solid #999;
  z-index: 10;
  font-size: 18px;
}

#scoreTable {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}

#scoreTable th, #scoreTable td {
  border: 2px solid #999;
  padding: 14px;
  text-align: center;
  font-weight: bold;
  min-width: 100px;
  font-size: 20px;
  background-color: white;
}

.colorBox {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  margin-right: 6px;
  vertical-align: middle;
}

    #endGameButton {
      display: block;
      width: 100%;
      padding: 10px 0;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background-color: #dc3545;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    #endGameButton:hover {
      background-color: #a71d2a;
    }

    .popup, .difficulty-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fefefe;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      padding: 24px;
      z-index: 100;
      width: 400px;
      text-align: center;
      display: none;
    }
    .difficulty-popup p {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .difficulty-popup button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .difficulty-popup button:nth-child(2) {
      background-color: #28a745;
      color: white;
    }
    .difficulty-popup button:nth-child(2):hover {
      background-color: #1e7e34;
    }
    .difficulty-popup button:nth-child(3) {
      background-color: #007bff;
      color: white;
    }
    .difficulty-popup button:nth-child(3):hover {
      background-color: #0056b3;
    }
    .difficulty-popup button:nth-child(4) {
      background-color: #dc3545;
      color: white;
    }
    .difficulty-popup button:nth-child(4):hover {
      background-color: #a71d2a;
    }
    .popup button, .difficulty-popup button {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #specialText {
      margin-top: 10px;
      font-weight: bold;
      color: #d9534f;
    }

    /* ì¡° ì´ë¦„ ì…ë ¥ì¹¸ ë””ìì¸ ë° ìˆ¨ê¹€ (ì²˜ìŒì—” ìˆ¨ê¹€) */
    #nameInputs {
      display: none;
      margin-top: 290px;
    }
    .playerName {
      font-size: 24px;
      padding: 12px 20px;
      border-radius: 20px;
      border: 2px solid #ccc;
      width: 300px;
      margin: 5px auto;
      display: block;
      box-sizing: border-box;
      text-align: center;
    }

    /* ì‹œì‘ ë²„íŠ¼ ë””ìì¸ (ê°€ìš´ë° ì •ë ¬) */
    #startButton {
      font-size: 32px;
      padding: 15px 40px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background-color: #fffafa;
      color: black;
      font-weight: bold;
      transition: background-color 0.3s;
      user-select: none;
      margin-top: 440px;
    }
    #startButton:hover {
      background-color: #7b071f;
    }
    @keyframes explode {
  0% {
    transform: scale(0.5);
    opacity: 0;
    text-shadow: 0 0 10px red;
  }
  50% {
    transform: scale(2.5);
    opacity: 1;
    text-shadow: 0 0 40px orange, 0 0 80px yellow;
  }
  100% {
    transform: scale(1);
    opacity: 0;
    text-shadow: none;
  }
}

#questionPopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 40px;        /* ì•ˆìª½ ì—¬ë°± í¬ê²Œ */
  border: 3px solid black;
  border-radius: 15px;
  width: 80%;           /* ê°€ë¡œ ë” í¬ê²Œ */
  max-width: 1000px;    /* ìµœëŒ€ ê°€ë¡œ í¬ê¸° */
  height: auto;
  font-size: 1.8em;     /* ì „ì²´ ê¸€ì í¬ê¸° í‚¤ì›€ */
  z-index: 1000;
}

.material-box {
  border: 1px solid #999;
  padding: 10px;
  margin: 10px 0;
  background: #f9f9f9;
}

.source {
  text-align: right;
  font-size: 0.9em;
  color: #555;
}

.fullscreen-answer {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 5em;
  font-weight: bold;
  color: red;
  z-index: 2000;
}

.answer-box {
  margin-top: 20px;
  font-size: 2em;
  font-weight: bold;
  color: red;
  text-align: center;
}

#choicesContainer {
  margin-top: 20px;   /* ë¬¸ì œì™€ ë³´ê¸° ì‚¬ì´ ê°„ê²© */
  display: grid;
  grid-template-columns: 1fr 1fr;  /* ë³´ê¸° 2ê°œì”© ê°€ë¡œ ë°°ì¹˜ */
  gap: 15px;          /* ë³´ê¸° ê°„ê²© */
}

#choicesContainer button {
  font-size: 1.2em;   /* ë³´ê¸° ê¸€ì í¬ê¸° í‚¤ì›€ */
  padding: 15px;      /* ë³´ê¸° ë²„íŠ¼ í¬ê¸° í‚¤ì›€ */
  border-radius: 10px;
  border: 2px solid #333;
  cursor: pointer;
}

#questionText {
  font-size: 2em;   /* â† ë¬¸ì œ ê¸€ì”¨ í¬ê²Œ */
  margin-bottom: 20px;
}

#explosionEffect {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 100px;
  color: #ff4444;
  z-index: 9999;
  display: none;
  pointer-events: none;
  animation: explode 1s ease-out;
}
  </style>
</head>
<body>
  <div id="startScreen">
    <!-- ì‹œì‘ ë²„íŠ¼ë§Œ ë¨¼ì € ë³´ì„ -->
    <button id="startButton">ì‹œì‘</button>
    
    <!-- ì¡° ì´ë¦„ ì…ë ¥ì¹¸ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
    <div id="nameInputs">
      <input type="text" placeholder="1ì¡°" class="playerName" />
      <input type="text" placeholder="2ì¡°" class="playerName" />
      <input type="text" placeholder="3ì¡°" class="playerName" />
      <input type="text" placeholder="4ì¡°" class="playerName" />
      <input type="text" placeholder="5ì¡°" class="playerName" />
      <input type="text" placeholder="6ì¡°" class="playerName" />
    </div>
  </div>

  <div id="gameContainer">
    <div id="mainArea">
      <div id="turnDisplay"></div>
      <div id="grid"></div>
    </div>

    <table id="scoreTable">
  <thead>
    <tr id="scoreHeaderRow"><th>ì¡° ì´ë¦„</th></tr>
  </thead>
  <tbody>
    <tr id="scoreDataRow"><th>ì ìˆ˜</th></tr>
  </tbody>
</table>
      <button id="endGameButton" onclick="endGame()">ê²Œì„ ì¢…ë£Œ</button>
    </div>
  </div>
  <div id="scorePanel" style="margin-top: 20px;">
  </div>

  <div class="difficulty-popup" id="difficultyPopup">
    <p>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
    <button onclick="selectDifficulty('í•˜')">í•˜</button>
    <button onclick="selectDifficulty('ì¤‘')">ì¤‘</button>
    <button onclick="selectDifficulty('ìƒ')">ìƒ</button>
  </div>

<!-- ë¬¸ì œ íŒì—… -->
<div id="questionPopup" style="display:none;">
  <div id="optionsContainer"></div>
  <div id="questionPopup" class="popup">
  <div id="questionText"></div>
  <div id="optionsContainer"></div> <!-- ë³´ê¸° ì¶œë ¥ ì˜ì—­ -->
  <button id="questionPopupAnswer">ì •ë‹µ ë³´ê¸°</button>
  <button id="questionPopupClose">ë‹«ê¸°</button>
</div>

  <!-- ë¬¸ì œ -->
  <p id="questionText" style="font-size: 24px; font-weight: bold;"></p>

  <!-- ìë£Œ ë°•ìŠ¤ -->
  <div id="materialBox" style="border: 2px solid #444; padding: 10px; margin: 10px 0; background:#f9f9f9;">
    <p id="questionResource" style="font-size:18px; margin:0;"></p>
    <p id="questionSource" style="text-align:right; font-size:14px; margin:0; color:#666;"></p>
  </div>

  <!-- ë³´ê¸° (ìˆìœ¼ë©´ í‘œì‹œë¨) -->
  <div id="choicesContainer" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;">
    <button id="choice1" onclick="answerMultipleChoice(0)"></button>
    <button id="choice2" onclick="answerMultipleChoice(1)"></button>
    <button id="choice3" onclick="answerMultipleChoice(2)"></button>
    <button id="choice4" onclick="answerMultipleChoice(3)"></button>
  </div>

  <!-- ì •ë‹µ/ì˜¤ë‹µ ë²„íŠ¼ -->
  <div style="margin-top:15px;">
    <button onclick="handleAnswer(true)" style="padding:10px 20px; font-size:18px;">ì •ë‹µ</button>
    <button onclick="handleAnswer(false)" style="padding:10px 20px; font-size:18px;">ì˜¤ë‹µ</button>
  </div>
</div>

<!-- ì •ë‹µ í‘œì‹œ ë°•ìŠ¤ -->
  <div id="answerDisplay" style="display:none;">
    <span id="correctAnswer"></span>
  </div>

<div id="fullscreenAnswer" class="fullscreen-answer" style="display:none;"></div>

  <div class="popup" id="rankingPopup">
    <h3>ê²Œì„ ê²°ê³¼</h3>
    <div id="rankingList" style="text-align: left; margin: 10px 0;"></div>
    <button onclick="closeRankingPopup()">ë‹«ê¸°</button>
  </div>

  <!-- ìŒì•… ì˜¤ë””ì˜¤ (íŒŒì¼ ê²½ë¡œ í™•ì¸ í•„ìš”) -->
  <audio id="bgm" src="the_motion.mp3"></audio>
  <audio id="startSound" src="start.mp3"></audio>
  <audio id="correctSound" src="correct.mp3" preload="auto"></audio><audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
  <audio id="specialSound" src="special.mp3" preload="auto"></audio>

  <script>
    let questionsFromSheet = [];
    let question;

async function loadQuestions() {
// ì´ì œ ì˜¤ë¥˜ ì•ˆ ë‚¨
console.log(questionsFromSheet.length);
}
    // ===== ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ =====
    const players = [];
    const playerColors = ["red", "orange", "yellow", "green", "blue", "purple"];
    let currentPlayer = 0;
    const usedQuestions = {}; // ì˜ˆ: { 'ê°œë´‰-í•˜': true }
    const cities = [
      "ì²­ì£¼", "ê°œë´‰", "êµí† ", "ê°€ì˜¤", "ë‰´ìš•", "ê°•í™”ë„", "ê´‘ì €ìš°", "ë‚˜ê°€ì‚¬í‚¤", "ìˆ˜ë§ˆíŠ¸ë¼", "ë¸Œë¤¼ì…€",
      "ê°œì„±", "ë‚™ì–‘", "ë‚˜ë¼", "ë¸í¬ì´", "ìš°í•œ", "ê²½ì£¼", "ë‚œì§•", "ë„ì¿„", "ëŸ°ë˜", "ìì¹´ë¥´íƒ€",
      "ê³µì£¼", "ì„±ë„", "ì˜¤ì‚¬ì¹´", "ë¡œë§ˆ", "íˆë¡œì‹œë§ˆ", "ê´‘ì£¼", "ë² ì´ì§•", "ì¹´ë¼ì½”ë£¸", "ë² ë¥¼ë¦°", "ìº„ì°¨ì¹´ë°˜ë„",
      "ê¹€ì œ", "ë‹ˆìŠ¤", "í•˜ë…¸ì´", "ë¦¬ìš°ë°ìë„¤ì´ë£¨", "ì‚¬ë¼ì˜ˆë³´", "ê¹€í•´", "ì–‘ì €ìš°", "ë‰´ë¸ë¦¬", "ë©”ì¹´", "ì˜¤ì‹œë¹„ì—¥ì¹¨",
      "ë‚˜ì£¼", "ì˜ê°€", "ì½œì¹´íƒ€", "ë©¤í”¼ìŠ¤", "í¬ë¼ìŠ¤ë…¸ì•¼ë¥´ìŠ¤í¬", "ëŒ€êµ¬", "ì¥ì•ˆ", "ì•™ì½”ë¥´", "ë°”í‹°ì¹¸", "í•¨ë¶€ë¥´í¬",
      "ë‚¨ì–‘ì£¼", "í†ˆì§„", "ì¹´íŠ¸ë§Œë‘", "ë² ë„¤ì¹˜ì•„", "ë…¼ì‚°", "ì¶©ì¹­", "í‚¤ì´ìš°", "ë³´ìŠ¤í„´", "í˜ë¥´ì„¸í´ë¦¬ìŠ¤", "í•­ì €ìš°",
      "ì˜¤í‚¤ë‚˜ì™€", "ë‹¹ì§„", "ë¹ˆ", "ì„œìš¸", "ìƒíŠ¸í˜í…Œë¥´ë¶€ë¥´í¬", "ëŒ€ë§ˆë„", "ì•„ë°”ë‚˜", "ìƒì£¼", "ì•„ë¹„ë‡½", "ìš¸ì‚°",
      "ì•„í—¨", "ì›ì‚°", "ì•…ìˆ¨", "ì„œì²œ", "ì—ë“ ë²„ëŸ¬", "ì˜ì£¼", "ì˜ˆë£¨ì‚´ë ˜", "ì¸ì²œ", "ìš¸ë£¬ë””", "ì˜í¥",
      "ì›Œì‹±í„´ D.C.", "ì œì£¼ë„", "ìŒë°˜ìì½©êµ¬", "ì§„ì£¼", "ì œë„¤ë°”", "ì² ì›", "ì¹´ë¥´íƒ€ê³ ", "ê³¡ì‚°", "ìº”ë²„ë¼", "ì˜ë ¹",
      "ìƒí•˜ì´", "ì²œì•ˆ", "ì´ìŠ¤íƒ„ë¶ˆ", "í‰ì–‘", "ì¿ ìŠ¤ì½”", "í•¨ì–‘", "í…Œë…¸ì¹˜í‹°í‹€ë€", "í†¨ë ˆë„", "íŒŒë¦¬", "ë¶€ì‚°"
    ];

    const specialCities = {
      "ìˆ˜ë§ˆíŠ¸ë¼": "ë¹„ìƒ! ëŒ€ì§€ì§„ ë°œìƒ!",
      "ì˜¤í‚¤ë‚˜ì™€": "ë¹„ìƒ! ì§€ì§„ ë°œìƒ!",
      "ìš°í•œ": "ì•— ë¹„ìƒ! ì½”ë¡œë‚˜ ì°½ê¶!",
      "ìì¹´ë¥´íƒ€": "ë¹„ìƒ! í™ìˆ˜ ë°œìƒ!",
      "íˆë¡œì‹œë§ˆ": "ë¹„ìƒ! í•˜ëŠ˜ì— í•µí­íƒ„ì´!",
      "ìº„ì°¨ì¹´ë°˜ë„": "ë¹„ìƒ! í™”ì‚° í­ë°œ!",
      "ì‚¬ë¼ì˜ˆë³´": "íƒ•!",
      "ì˜¤ì‹œë¹„ì—¥ì¹¨": "ë¹„ìƒ! ë…ì¼ì´ ìˆ˜ìš©ì†Œë¡œ ì‚¬ëŒë“¤ì„ ëŒê³  ê°„ë‹¤!",
      "í¬ë¼ìŠ¤ë…¸ì•¼ë¥´ìŠ¤í¬": "ë¹„ìƒ! í‰êµ¬ìŠ¤ì¹´ ëŒ€í­ë°œ ë°œìƒ!",
      "í•¨ë¶€ë¥´í¬": "ì•— ë¹„ìƒ! ì½œë ˆë¼ ì°½ê¶!"
    };

    const startPositionsIndexes = [0, 9, 90, 99, 4, 95];
    const startPositions = startPositionsIndexes.map(i => cities[i]);

    const fixedQuestions = {
      í•˜: cities.reduce((acc, city, i) => {
        if(city) acc[city] = `${city} í•˜ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ ${i + 1}`;
        return acc;
      }, {}),
      ì¤‘: cities.reduce((acc, city, i) => {
        if(city) acc[city] = `${city} ì¤‘ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ ${i + 1}`;
        return acc;
      }, {})
    };

    const hardQuestions = [
      "ìƒ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ 1",
      "ìƒ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ 2",
      "ìƒ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ 3",
      "ìƒ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ 4",
      "ìƒ ë‚œì´ë„ ë¬¸ì œ ì˜ˆì‹œ 5"
    ];

    let selectedCity = "";
    let selectedDifficulty = "";  // ë‚œì´ë„ ì €ì¥ìš©
    let currentQuestion = null; // í˜„ì¬ ë¬¸ì œ ì „ì—­ ë³€ìˆ˜

   function openDifficultyPopup(city) {
  selectedCity = city;

  const levels = ["í•˜", "ì¤‘", "ìƒ"];
  levels.forEach((level, index) => {
    const button = document.querySelector(`#difficultyPopup button:nth-child(${index + 2})`);
    const key = `${city}-${level}`;
    if (usedQuestions[key]) {
      button.disabled = true;
      button.style.backgroundColor = "#ccc";
      button.style.cursor = "not-allowed";
      button.style.color = "#666";
    } else {
      button.disabled = false;

      // ì›ë˜ ìŠ¤íƒ€ì¼ ë³µì›
      if (level === "í•˜") {
        button.style.backgroundColor = "#28a745"; // ê¸°ë³¸
        button.style.color = "white";
      } else if (level === "ì¤‘") {
        button.style.backgroundColor = "#007bff";
        button.style.color = "white";
      } else if (level === "ìƒ") {
        button.style.backgroundColor = "#dc3545";
        button.style.color = "white";
      }
      button.style.cursor = "pointer";
    }
  });

  document.getElementById("difficultyPopup").style.display = "block";
}

    function selectDifficulty(level) {
  selectedDifficulty = level;    // ë‚œì´ë„ ì €ì¥
  document.getElementById("difficultyPopup").style.display = "none";

  const key = `${selectedCity}-${level}`;
  if (usedQuestions[key]) {
    alert("ì´ë¯¸ í‘¼ ë¬¸ì œì…ë‹ˆë‹¤!");
    return;
  }
  usedQuestions[key] = true;  // ì‚¬ìš© ê¸°ë¡ ì €ì¥

  question = "";
  if (level === "ìƒ") {
    question = hardQuestions[Math.floor(Math.random() * hardQuestions.length)];
  } else {
    question = fixedQuestions[level][selectedCity];
  }

  if (!question) {
    alert("ë¬¸ì œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
    return;
  }

  showQuestion(question);
}
function showQuestion(question) {
  document.getElementById("questionText").textContent = question;
  document.getElementById("questionPopup").style.display = "block";
  document.getElementById("materialBox").style.display = "none"; // ê¸°ë³¸ ìˆ¨ê¹€
  document.getElementById("choicesContainer").style.display = "none"; // ê¸°ë³¸ ìˆ¨ê¹€

  // 1. ë¬¸ì œ ì°¾ê¸°
  question = questionsFromSheet.find(
    q => q.ë„ì‹œëª… === city && q.ë‚œì´ë„ === difficulty
  );

  if (!question) {
    console.error("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", city, difficulty);
    return;
  }
  console.log(questionsFromSheet.find(q => q.ë„ì‹œëª… === city && q.ë‚œì´ë„ === difficulty));
  if (question.options && typeof question.options === "string") {
  question.options = question.options.split(",").map(opt => opt.trim());
}

    // 2. ë¬¸ì œ í…ìŠ¤íŠ¸ í‘œì‹œ
  const questionContainer = document.getElementById("questionContainer");
  if (questionContainer) {
    questionContainer.innerHTML = question.ë¬¸ì œ;
  } else {
    console.error("questionContainer ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }

  // ë¬¸ì œ í…ìŠ¤íŠ¸
    document.getElementById("questionText").innerText = question.question || "";
     if (question.resource) {
    document.getElementById("materialBox").style.display = "block";
    document.getElementById("questionResource").innerText = question.resource;
    document.getElementById("questionSource").innerText = question.source || "";
  } else {
    document.getElementById("materialBox").style.display = "none";
  }

  // ìë£Œ + ì¶œì²˜
  document.getElementById("material").textContent = question.material || "";
  document.getElementById("source").textContent = question.source || "";
 if (question.ìë£Œ) {
    document.getElementById("materialBox").style.display = "block";
    document.getElementById("questionResource").innerText = question.ìë£Œ;
    document.getElementById("questionSource").innerText = question["ìë£Œ ì¶œì²˜"] || "";
  } else {
    document.getElementById("materialBox").style.display = "none";
  }

  // ë³´ê¸° (ì—†ìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¹€)
  let choices = [question.ë³´ê¸°1, question.ë³´ê¸°2, question.ë³´ê¸°3, question.ë³´ê¸°4];
  for (let i = 0; i < 4; i++) {
    let btn = document.getElementById("choice" + (i + 1));
    if (choices[i]) {
      btn.style.display = "inline-block";
      btn.innerText = choices[i];
    } else {
      btn.style.display = "none";
    }
  }
  
  // ì •ë‹µ ì˜ì—­ì€ í•­ìƒ ìˆ¨ê¹€ (ì²˜ìŒ ë¬¸ì œ ë³´ì—¬ì¤„ ë•Œ)
  document.getElementById("answerDisplay").style.display = "none";

    // íŒì—… ë³´ì´ê¸°
    document.getElementById("questionPopup").style.display = "block";
}

  let questionsLoaded = false;

window.addEventListener("load", async () => {
  await loadQuestions();
  questionsLoaded = true; // ë¡œë“œ ì™„ë£Œ í‘œì‹œ
});

// ì •ë‹µ/ì˜¤ë‹µ ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‹¤í–‰
function checkAnswer(isCorrect) {
  // ì •ë‹µ í‘œì‹œ
  document.getElementById("answerDisplay").style.display = "block";
  document.getElementById("correctAnswer").innerText = questionPopupAnswer;

  // ì ìˆ˜ ë°˜ì˜
  if (isCorrect) {
    if (currentQuestion.ë‚œì´ë„ === "í•˜") playerscores[currentPlayer] += 1;
    if (currentQuestion.ë‚œì´ë„ === "ì¤‘") playerscores[currentPlayer] += 2;
    if (currentQuestion.ë‚œì´ë„ === "ìƒ") playerscores[currentPlayer] += 3;
  }
  updateScoreboard();
}

  // ë³´ê¸° ì¶œë ¥ (ì¼ë ¬)
  const optionsContainer = document.getElementById("optionsContainer");
  optionsContainer.innerHTML = "";
  if (question && question.options && question.options.length > 0) {
  question.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.className = "option-btn";
    optionsContainer.appendChild(btn);
  });
} else {
  console.warn("ë³´ê¸° ì˜µì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", question);
}
  
  if (question.ë³´ê¸° && question.ë³´ê¸°.length > 0) {
    document.getElementById("choicesContainer").style.display = "block";
    question.ë³´ê¸°.forEach((choice, i) => {
      document.getElementById("choice"+(i+1)).innerText = choice;
    });
  } else {
    document.getElementById("choicesContainer").style.display = "none";
  }

  // íŒì—… ë³´ì´ê¸°
  document.getElementById("questionPopup").style.display = "block";

  // ì •ë‹µ ìˆ¨ê¹€
  document.getElementById("answerBox").style.display = "none";
  document.getElementById("correctAnswer").textContent = question.answer;

  document.getElementById("questionPopup").style.display = "block";

function markAnswer(isCorrect) {
  const answerText = isCorrect ? "ì •ë‹µ!" : "ì˜¤ë‹µ!";
  const answerBox = document.getElementById("fullscreenAnswer");
  answerBox.innerText = answerText;
  answerBox.style.display = "flex";

  setTimeout(() => {
    answerBox.style.display = "none";
    document.getElementById("questionPopup").style.display = "none";
  }, 2000);

  // ì ìˆ˜ ì¶”ê°€ (ì˜ˆì‹œ: ë‚œì´ë„ í•˜=1, ì¤‘=2, ìƒ=3)
  if (isCorrect) {
    let scoreToAdd = 1; // ê¸°ë³¸ í•˜ ë‚œì´ë„
    if (selectedDifficulty === "ì¤‘") scoreToAdd = 2;
    if (selectedDifficulty === "ìƒ") scoreToAdd = 3;
    playerscores[selectedDifficulty] += scoreToAdd;
  }

  nextTurn();
}

// ì •ë‹µ / ì˜¤ë‹µ ë²„íŠ¼
// ì •ë‹µ/ì˜¤ë‹µ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
function handleAnswer(isCorrect) {
  const answerOverlay = document.getElementById("answerOverlay");

  if (isCorrect) {
    answerOverlay.innerText = "ì •ë‹µ!";

    // ì ìˆ˜ ì¶”ê°€ (ë‚œì´ë„ì— ë”°ë¼ ì ìˆ˜ ê³„ì‚°)
    let scoreToAdd = 0;
    if (selectedDifficulty === "í•˜") scoreToAdd = 1;
    if (selectedDifficulty === "ì¤‘") scoreToAdd = 2;
    if (selectedDifficulty === "ìƒ") scoreToAdd = 3;

    playerscores[currentPlayer] += scoreToAdd;
    updateScoreboard();
  } else {
    answerOverlay.innerText = "ì˜¤ë‹µ!";
  }

  // ì •ë‹µ/ì˜¤ë‹µ í™”ë©´ í‘œì‹œ
  answerOverlay.style.display = "flex";

  // 2ì´ˆ í›„ ë‹«ê¸°
  setTimeout(() => {
    answerOverlay.style.display = "none";
    closeQuestionPopup();
  }, 2000);
}

    function answerQuestion(correct) {
  document.getElementById("questionPopup").style.display = "none";

  const cells = document.querySelectorAll(".cell"); // ì—¬ê¸° ì„ ì–¸ í•„ìš”

  if (correct) {
    const correctSound = document.getElementById("correctSound");
    correctSound.volume = 0.6;
    correctSound.play().catch(err => {
      console.log("ì •ë‹µ íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:", err);
    });

    let points = 0;
    if (selectedDifficulty === "í•˜") points = 1;
    else if (selectedDifficulty === "ì¤‘") points = 2;
    else if (selectedDifficulty === "ìƒ") points = 3;

    playerscores[players[currentPlayer]] += points;

    cells.forEach(cell => {
      if (cell.textContent.trim() === selectedCity) {
        cell.style.backgroundColor = playerColors[currentPlayer];
        cell.style.color = "white";
        cell.style.fontWeight = "bold";
      }
    });

    updateScoreTable();
  } else {
    const wrongSound = document.getElementById("wrongSound");
    wrongSound.volume = 0.6;
    wrongSound.play().catch(err => {
      console.log("ì˜¤ë‹µ íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:", err);
    });
  }

  currentPlayer = (currentPlayer + 1) % players.length;
  updateTurnDisplay();

}

    const playerscores = {};

      // ===== êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë¶ˆëŸ¬ì˜¨ ë¬¸ì œ ì €ì¥ =====
  async function loadQuestions() {
    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUv4xOGCdaDnzuT6kxXcldcEVDnxc6g1rhpG2rkcE_Rq_MR-w946zTjv0d62Uu6aVKgEA7OKjapyUI/pub?output=csv'; // ì—¬ê¸°ì— CSV ê³µê°œ ë§í¬ ì…ë ¥
    const response = await fetch(url);
    const data = await response.text();

    // PapaParseë¡œ CSV íŒŒì‹±
  const parsed = Papa.parse(data, { header: true, skipEmptyLines: true });

  questionsFromSheet = parsed.data.map(row => ({
    city: row.ë„ì‹œëª… || row.city,
    difficulty: row.ë‚œì´ë„ || row.difficulty,
    question: row.ë¬¸ì œ || row.question,
    resource: row.ìë£Œ || row.resource,
    source: row['ìë£Œ ì¶œì²˜'] || row.source,
    answer: row.ë‹µ || row.answer,
    choice1: row.ë³´ê¸°1 || row.choice1,
    choice2: row.ë³´ê¸°2 || row.choice2,
    choice3: row.ë³´ê¸°3 || row.choice3,
    choice4: row.ë³´ê¸°4 || row.choice4
  }));

   console.log("ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:", questionsFromSheet);
  console.log('íŒŒì‹±ëœ ë¬¸ì œ:', questionsFromSheet);

    const rows = data.split('\n').slice(1); // í—¤ë” ì œì™¸
    rows.forEach(row => {
  const [city, difficulty, question, resource, source, answer, choice1, choice2, choice3, choice4] = row.split(',');
  if(city && difficulty && question) {
    questionsFromSheet.push({ city, difficulty, question, resource, source, answer, choice1, choice2, choice3, choice4 });
  }
});
    console.log('ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ:', questionsFromSheet);

  // í—¤ë” ì œì™¸í•˜ê³  ë°ì´í„° ì €ì¥
  questions = rows.slice(1).map(r => ({
    city: r[1],
    level: r[2],
    question: r[3],
    source: r[5],
    answer: r[6]
  }));

  console.log("íŒŒì‹±ëœ ë¬¸ì œ:", questions);
  }

  window.addEventListener("load", async () => {
    await loadQuestions();
  });

  // ===== ë‚œì´ë„ ì„ íƒ í›„ ë¬¸ì œ ë³´ì—¬ì£¼ê¸° =====

    function startGame() {
      window.addEventListener("load", async () => {
  await loadQuestions();
  questionsLoaded = true; // ì—¬ê¸°ê°€ í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡
});

   document.getElementById("startScreen").style.display = "none"; 
 const inputs = document.querySelectorAll(".playerName");
  players.length = 0; 
  inputs.forEach(input => {
    const name = input.value.trim();
    if (name) players.push(name);
  });

  if (players.length < 1) {
    alert("ìµœì†Œ 1ëª…ì˜ í”Œë ˆì´ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤!");
    return;
  }

// playerScores ì´ˆê¸°í™”
      for (const key in playerscores) delete playerscores[key];
      players.forEach(p => {
        playerscores[p] = 0;
        currentPlayer = 0;
      });

  // ê²Œì„ í™”ë©´ í‘œì‹œ
  document.getElementById("gameContainer").style.display = "flex";
  document.getElementById("scorePanel").classList.add("show"); // ì ìˆ˜íŒ ë³´ì´ê¸°

  drawBoard();
  updateTurnDisplay();
  updateScoreTable();

  // ë°°ê²½ ë³€ê²½
  document.body.style.backgroundImage = "none";
  document.body.style.backgroundColor = "black";

      // íš¨ê³¼ìŒ ì¬ìƒ
const startSound = document.getElementById("startSound");
startSound.play().catch(err => {
  console.log("ì‹œì‘ íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:", err);
});
    }

    function showSpecialEvent(city) {
      selectedCity = city;
      selectedDifficulty = "í•˜"; // ì ìˆ˜ë¥¼ ìœ„í•´ ë‚œì´ë„ëŠ” í•˜ë¡œ ê³ ì •
      document.getElementById("questionText").textContent = "";
      document.getElementById("specialText").textContent = specialCities[city];
      document.getElementById("questionPopup").style.display = "block";
      selectedCity = city;
  selectedDifficulty = "í•˜"; // ì ìˆ˜ë¥¼ ìœ„í•´ ë‚œì´ë„ëŠ” í•˜ë¡œ ê³ ì •
  document.getElementById("questionText").textContent = "";
  document.getElementById("specialText").textContent = specialCities[city];
  document.getElementById("questionPopup").style.display = "block";

  // ğŸµ íŠ¹ìˆ˜ íš¨ê³¼ìŒ ì¬ìƒ
  const specialSound = document.getElementById("specialSound");
  specialSound.play().catch(err => {
    console.log("íŠ¹ìˆ˜ íš¨ê³¼ìŒ ì¬ìƒ ì‹¤íŒ¨:", err);
  });
    }

    let questionPopupAnswer = ""; // ì •ë‹µ ì €ì¥ìš©

function answerMultipleChoice(choiceIndex) {
  const selectedBtn = document.getElementById(`choice${choiceIndex+1}`);
  const selectedText = selectedBtn.textContent;

  const correct = selectedText === questionPopupAnswer;

  answerQuestion(correct); // ê¸°ì¡´ answerQuestion ì¬ì‚¬ìš©  
}

    function drawBoard() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      cities.forEach((city, idx) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = city;
        cell.onclick = () => {
          if (specialCities[city]) {
            showSpecialEvent(city);
          } else {
            openDifficultyPopup(city);
          }
        };
        const startIndex = startPositions.indexOf(city);
        if (startIndex !== -1 && startIndex < players.length) {
          cell.style.backgroundColor = playerColors[startIndex];
          cell.style.color = "white";
          cell.style.fontWeight = "bold";
        }
        grid.appendChild(cell);
      });
    }

  function updateScoreTable() {
  const headerRow = document.getElementById("scoreHeaderRow");
  const dataRow = document.getElementById("scoreDataRow");

  headerRow.innerHTML = "<th>ì¡°ëª…</th>";
  dataRow.innerHTML = "<th>ì ìˆ˜</th>";

  players.forEach((player, idx) => {
    headerRow.innerHTML += `<th><span class="colorBox" style="background-color:${playerColors[idx]}"></span>${player}</th>`;
    dataRow.innerHTML += `<td>${playerscores[player]}</td>`;
  });
}

    function updateTurnDisplay() {
      if (players.length > 0) {
        document.getElementById("turnDisplay").textContent = `${players[currentPlayer]}`;
        document.getElementById("turnDisplay").style.color = playerColors[currentPlayer];
      }
    }
    function endGame() {
  // ğŸ’¥ í­ë°œ íš¨ê³¼ ì‹¤í–‰
  const explosion = document.getElementById("explosionEffect");
  explosion.style.display = "block";
  explosion.style.animation = "explode 1s ease-out";

  // 1ì´ˆ í›„ ì œê±°
  setTimeout(() => {
    explosion.style.display = "none";
  }, 1000);

  // ìˆœìœ„ ê³„ì‚°
  let ranking = [...players];
  ranking.sort((a, b) => playerscores[b] - playerscores[a]);

  let rankingText = "";
  ranking.forEach((player, i) => {
    let fontSize = 36 - i * 4; // 1ë“±: 36px â†’ 2ë“±: 32px ...
    if (fontSize < 16) fontSize = 16;

    let style = `
      font-size: ${fontSize}px;
      font-weight: ${i === 0 ? 'bold' : 'normal'};
      color: ${i === 0 ? '#d9534f' : '#222'};
      margin-bottom: 10px;
      text-align: center;
    `;
    rankingText += `<div style="${style}">${i + 1}ìœ„ ${player} - ì ìˆ˜: ${playerscores[player]}</div>`;
  });

  document.getElementById("rankingList").innerHTML = rankingText;
  document.getElementById("rankingPopup").style.display = "block";
}
   
    function closeRankingPopup() {
      document.getElementById("rankingPopup").style.display = "none";
    }

    // ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë¦„ ì…ë ¥ì¹¸ í‘œì‹œ
    document.getElementById("startButton").addEventListener("click", () => {
    document.getElementById("startButton").style.display = "none";
    document.getElementById("nameInputs").style.display = "block";
});

      // âœ… ìŒì•… ì¬ìƒ
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.3;     // ë³¼ë¥¨ ì¡°ì ˆ (0 ~ 1)
  bgm.loop = true;      // ë°˜ë³µ ì¬ìƒ
  bgm.play().catch(err => {
    console.log("ìŒì•… ìë™ ì¬ìƒì´ ì°¨ë‹¨ë¨:", err);
  });

    // ì¡° ì´ë¦„ ì…ë ¥ ì™„ë£Œ í›„ ì—”í„° ëˆŒëŸ¬ë„ ê²Œì„ ì‹œì‘ ê°€ëŠ¥
    document.querySelectorAll(".playerName").forEach(input => {
  input.addEventListener("keypress", e => {
    if (e.key === "Enter") {
      startGame();
    }
  });
});

    // ì…ë ¥ì¹¸ 6ê°œ ì¤‘ í•˜ë‚˜ë¼ë„ ë³€ê²½ë˜ë©´ í”Œë ˆì´ì–´ ì´ë¦„ ìë™ ì—…ë°ì´íŠ¸
    document.querySelectorAll(".playerName").forEach(input => {
      input.addEventListener("input", () => {
        // ìë™ìœ¼ë¡œ í”Œë ˆì´ì–´ ì´ë¦„ ê°±ì‹ 
        // (ì¶”ê°€ êµ¬í˜„ ê°€ëŠ¥)
      });
    });
  </script>
  <div id="explosionEffect" style="display: none;">ğŸ’¥</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</body>
</html>