<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>지구는 내 거야!</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background-image: url('background.png');
      background-size: cover;            /* 화면을 꽉 채움 */
      background-position: center;       /* 가운데 정렬 */
      background-repeat: no-repeat;      /* 반복하지 않음 */
      background-attachment: fixed;      /* 스크롤해도 고정된 배경 (선택) */
      margin: 0;
  padding: 0;
  height: 100%;
  overflow: auto;
}
    #startScreen {
      padding: 20px;
    }
  
#gameContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  overflow-y: auto; /* 점수판만 스크롤됨 */
}

#mainArea {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  height: 100vh; /* 전체 화면 높이 */
  box-sizing: border-box;
  overflow: hidden;
}

#grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: repeat(10, 1fr);
  gap: 2px;
  width: 100vw;
  height: 90vh; /* 화면의 90%만 사용해서 격자판 표시 */
  box-sizing: border-box;
}

.cell {
  background: #eee;
  border: 1px solid #999;
  font-size: 1.8vmin;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 4px;
  word-break: break-word;
  text-align: center;
  box-sizing: border-box;
  height: 100%;   /* 각 셀의 높이는 자동으로 결정됨 */
  width: 100%;
}

#showAnswerBtn {
    background-color: #b8b8b8;
    color: black;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    position: absolute;
    bottom: 0px;     /* 아래쪽 여백 */
    right: 10px;      /* 오른쪽 여백 */
    font-size: 14px;  /* 글자 크기 작게 */
    padding: 5px 10px; /* 버튼 크기 줄임 */
}

#showAnswerBtn:hover {
    background-color: #84b2d3;
}

#resourceBox {
    font-size: 36px;        /* 글자 크기 키움 */
    margin:0;         /* 위아래 여백 줄임 */
    padding: 6px;
    text-align: left;       /* 왼쪽 정렬 */
}

#resourceBox a {
    font-size: 48px;        /* 링크 글자 크기도 동일하게 키움 */
    color: #1a73e8;         /* 링크 색상 */
    text-decoration: underline;
}

#scorePanel {
  flex-shrink: 0;
  width: 100%;
  display: flex !important;
  flex-direction: column;
  overflow-x: auto;
  padding: 20px;
  box-sizing: border-box;
  background-color: white; /* 배경 흰색 */
  border-radius: 8px;
  text-align: center;
  user-select: none;
  border-top: 4px solid #999;
  border-bottom: 4px solid #999;
  z-index: 10;
  font-size: 18px;
}

#scoreTable {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}

#scoreTable th, #scoreTable td {
  border: 2px solid #999;
  padding: 14px;
  text-align: center;
  font-weight: bold;
  min-width: 100px;
  font-size: 20px;
  background-color: white;
}

.colorBox {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  margin-right: 6px;
  vertical-align: middle;
}

#endGameButton {
      display: block;
      width: 100%;
      padding: 10px 0;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background-color: #dc3545;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }

#endGameButton:hover {
      background-color: #a71d2a;
    }

    .popup, .difficulty-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fefefe;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      padding: 24px;
      z-index: 100;
      width: 400px;
      text-align: center;
      display: none;
    }
    .difficulty-popup p {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .difficulty-popup button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .difficulty-popup button:nth-child(2) {
      background-color: #28a745;
      color: white;
    }
    .difficulty-popup button:nth-child(2):hover {
      background-color: #1e7e34;
    }
    .difficulty-popup button:nth-child(3) {
      background-color: #007bff;
      color: white;
    }
    .difficulty-popup button:nth-child(3):hover {
      background-color: #0056b3;
    }
    .difficulty-popup button:nth-child(4) {
      background-color: #dc3545;
      color: white;
    }
    .difficulty-popup button:nth-child(4):hover {
      background-color: #a71d2a;
    }
    .popup button, .difficulty-popup button {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
    }

#specialText {
      margin-top: 10px;
      font-weight: bold;
      color: #d9534f;
    }

    /* 조 이름 입력칸 디자인 및 숨김 (처음엔 숨김) */
    #nameInputs {
      display: none;
      margin-top: 360px;
    }
    .playerName {
      font-size: 24px;
      padding: 12px 20px;
      border-radius: 20px;
      border: 2px solid #ccc;
      width: 300px;
      margin: 5px auto;
      display: block;
      box-sizing: border-box;
      text-align: center;
    }

    /* 시작 버튼 디자인 (가운데 정렬) */
    #startButton {
      font-size: 32px;
      padding: 15px 40px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background-color: #fffafa;
      color: black;
      font-weight: bold;
      transition: background-color 0.3s;
      user-select: none;
      margin-top: 440px;
    }
    #startButton:hover {
      background-color: #7b071f;
    }
    @keyframes explode {
  0% {
    transform: scale(0.5);
    opacity: 0;
    text-shadow: 0 0 10px red;
  }
  50% {
    transform: scale(2.5);
    opacity: 1;
    text-shadow: 0 0 40px orange, 0 0 80px yellow;
  }
  100% {
    transform: scale(1);
    opacity: 0;
    text-shadow: none;
  }
}

#questionPopup {
  display: relative;             /* 플렉스로 세로 정렬 */
  flex-direction: column;    /* 세로 방향 */
  margin: 0;                 /* 바깥 여백 제거 */
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 5px;
  border: 2px solid black;
  border-radius: 12px;
  width: 1000px;
  height: 500px;
  max-height: 80vh;
  overflow-y: auto;  /* 스크롤  */
  font-size: 2.5vmin;     /* 화면 크기에 따라 글자 자동 조절 */
  z-index: 1000;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  overflow-y: auto;
  gap: 4px;
}

.material-box {
  border: 1px solid #999;
  padding: 10px;
  margin: 10px 0;
  background: #f9f9f9;
  white-space: pre-line;   /* 줄바꿈(\n) 표시 */
}

.source {
  text-align: right;
  font-size: 0.9em;
  color: #555;
}

.fullscreen-answer {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    color: #ff0000;
    font-size: 6em;
    font-weight: bold;
    justify-content: center;
    align-items: center;
    text-align: center;
    z-index: 9999;
    display: flex; /* flex로 중앙 정렬 */
    flex-direction: column;
}

.answer-box {
  margin-top: 20px;
  font-size: 2em;
  font-weight: bold;
  color: red;
  text-align: center;
}

#choicesContainer {
  margin: 4px 0;       /* 위아래 여백 제거 */
  padding: 5px;    /* 조금만 안쪽 여백 */
  width: 90%;      /* 폭 조정 */
  box-sizing: border-box; /* 패딩 포함 폭 계산 */
  display: flex;
  flex-direction: column; /* 세로 정렬 */
}

#choicesContainer button {
  font-size: 16px;   /* 보기 글자 크기 키움 */
  padding: 5px 10px;      /* 보기 버튼 크기 키움 */
  border-radius: 10px;
  border: 2px solid #333;
  cursor: pointer;
}

#questionText {
  font-size: 30px;   /* ← 문제 글씨 크게 */
  font-weight: bold;
  margin: 0;       /* 위아래 여백 제거 */
  padding: 0;      /* 패딩 제거 */
  text-align: center;
  white-space: pre-line;   /* 줄바꿈(\n) 표시 */
}

#explosionEffect {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 100px;
  color: #ff4444;
  z-index: 9999;
  display: none;
  pointer-events: none;
  animation: explode 1s ease-out;
}
  </style>
</head>
<body>
  <div id="startScreen">
    <!-- 시작 버튼만 먼저 보임 -->
    <button id="startButton">시작</button>
    
    <!-- 조 이름 입력칸 (처음엔 숨김) -->
    <div id="nameInputs">
      <input type="text" placeholder="1조" class="playerName" />
      <input type="text" placeholder="2조" class="playerName" />
      <input type="text" placeholder="3조" class="playerName" />
      <input type="text" placeholder="4조" class="playerName" />
    </div>
  </div>

  <div id="gameContainer">
    <div id="mainArea">
      <div id="turnDisplay"></div>
      <div id="grid"></div>
    </div>

    <table id="scoreTable">
  <thead>
    <tr id="scoreHeaderRow"><th>조 이름</th></tr>
  </thead>
  <tbody>
    <tr id="scoreDataRow"><th>점수</th></tr>
  </tbody>
</table>
      <button id="endGameButton" onclick="endGame()">게임 종료</button>
    </div>
  </div>
  <div id="scorePanel" style="margin-top: 20px;">
  </div>

  <div class="difficulty-popup" id="difficultyPopup">
    <p>난이도를 선택하세요:</p>
    <button onclick="selectDifficulty('하')">하</button>
    <button onclick="selectDifficulty('중')">중</button>
    <button onclick="selectDifficulty('상')">상</button>
  </div>

  <div id="specialEventText"></div>
  <div id="resEl"></div>

<!-- 문제 팝업 -->
<div id="questionPopup" class="popup" style="display:none;">
  <button id="questionPopupClose" style="position:absolute; top:10px; right:10px;">✖</button>
  <div id="optionsContainer"></div> <!-- 보기 출력 영역 -->

  <div id="answerBox"></div>
  
  <div id="specialText" style="display:none;"></div>
  <div id="questionContent"></div>

  <!-- 문제 -->
  <div id="questionText" style="display:none; font-size:24px; font-weight:bold;"></div>

  <!-- 자료 박스 -->
  <div id="resourceBox" style="border: 2px solid #444; padding: 10px; margin: 10px 0; background:#f9f9f9; font: size 60px;">
    <p id="questionResource" style="font-size:18px; margin:0;"></p>
    <p id="questionSource" style="text-align:right; font-size:14px; margin:0; color:#666;"></p>
  </div>

  <!-- 보기 (있으면 표시됨) -->
  <div id="choicesContainer" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;">
    <button id="choice1" onclick="answerMultipleChoice(0)"></button>
    <button id="choice2" onclick="answerMultipleChoice(1)"></button>
    <button id="choice3" onclick="answerMultipleChoice(2)"></button>
    <button id="choice4" onclick="answerMultipleChoice(3)"></button>
  </div>

  <!-- 정답/오답 버튼 -->
  <div style="margin-top:15px;">
    <button onclick="handleAnswer(true)" style="padding:10px 20px; font-size:18px;">정답</button>
    <button onclick="handleAnswer(false)" style="padding:10px 20px; font-size:18px;">오답</button>
    <button id="showAnswerBtn" style="padding:10px 20px; font-size:18px;">정답 확인</button>
</div>
  </div>

  <!-- 정답 표시 박스 -->
  <div id="answerDisplay" style="display:none;">
    <span id="correctAnswer"></span>
  </div>
</div>
</div>

<div id="fullscreenAnswer" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    color:white;
    font-size:3em;
    justify-content:center;
    align-items:center;
    text-align:center;
    z-index:9999;
">
</div>

  <div class="popup" id="rankingPopup">
    <h3>게임 결과</h3>
    <div id="rankingList" style="text-align: left; margin: 10px 0;"></div>
    <button onclick="closeRankingPopup()">닫기</button>
  </div>

  <!-- 음악 오디오 (파일 경로 확인 필요) -->
  <audio id="bgm" src="the_motion.mp3"></audio>
  <audio id="startSound" src="start.mp3"></audio>
  <audio id="correctSound" src="correct.mp3" preload="auto"></audio><audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
  <audio id="specialSound" src="special.mp3" preload="auto"></audio>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let questionsFromSheet = [];
    let currentQuestion;
    let selectedCity = "";
    let selectedDifficulty = null;
    let questionsLoaded = false;
    let usedHardQuestions = []; // 상 난이도 문제 사용 기록

async function loadQuestions() {
  if (questionsLoaded) return;
  return new Promise((resolve, reject) => {
   Papa.parse("earthq.csv", {
  download: true,
  header: true,
  quoteChar: '"',
  skipEmptyLines: true,
  complete: function(results) {
    questionsFromSheet = results.data.filter(q => q.question); // 빈 문제 제외
    console.log("CSV 파싱 완료, 총 문제 수:", questionsFromSheet.length);
    console.log("첫 문제:", questionsFromSheet[0]);
    console.log(Object.keys(questionsFromSheet[0]));
            questionsLoaded = true;
    resolve();
      },
      error: function(err) {
        console.error("CSV 로딩 실패:", err);
        reject(err);
    }});
  })
    console.log("게임 시작 전 CSV 데이터:", questionsFromSheet, "총 길이:", questionsFromSheet.length);

    if (!questionsFromSheet || questionsFromSheet.length === 0) {
        alert("문제 데이터가 없습니다!");
        return;
    }
     // 선택지 버튼 생성
  let choices = [currentQuestion.choice1, currentQuestion.choice2, currentQuestion.choice3, currentQuestion.choice4];
choices.forEach((choice, i) => {
    const btn = document.getElementById("choice" + (i + 1));
    if (choice) {
        btn.style.display = "inline-block";
        btn.innerText = choice;
    } else {
        btn.style.display = "none";
    }
});

if (specialCities[selectedCity]) {
   currentQuestion = { city: selectedCity, isSpecial: true };
   showQuestion(currentQuestion);
   return;
}

    // ✅ 일반 도시 → 문제 검색
    const question = questions.find(
        q => q.city === city && q.difficulty === difficulty
    );
};
      document.getElementById("startButton").addEventListener("click", () => {
      document.getElementById("startButton").style.display = "none";
      document.getElementById("nameInputs").style.display = "block";
  });

window.addEventListener("load", async () => {
    try {
        await loadQuestions();
        console.log("CSV 파싱 완료:", questionsFromSheet.length);

        if (!questionsFromSheet || questionsFromSheet.length === 0) {
            alert("문제 데이터가 없습니다!");
            return;
        }

        // 시작 버튼 활성화
        const startBtn = document.getElementById("startButton");
        startBtn.disabled = false;

        startBtn.addEventListener("click", () => {
            startBtn.style.display = "none";
            document.getElementById("nameInputs").style.display = "block";
            // 이름 입력 후 게임 시작 버튼에서 showQuestion 호출
        });

    } catch (err) {
        console.error("CSV 로딩 중 오류:", err);
    }
});

    // ===== 기존 스크립트 유지 =====
    const players = [];
    const playerColors = ["red", "orange", "green", "blue"];
    let currentPlayer = 0;
    const usedQuestions = {}; // 예: { '개봉-하': true }
    const cities = [
      "청주", "히로시마", "교토", "이스탄불", "뉴욕", "강화도", "광저우", "나가사키", "수마트라", "브뤼셀",
      "개성", "낙양", "나라", "델포이", "우한", "경주", "난징", "도쿄", "런던", "제주도",
      "공주", "성도", "자카르타", "로마", "개봉", "함양", "베이징", "카라코룸", "아비뇽", "철원",
      "김제", "니스", "하노이", "리우데자네이루", "빈", "김해", "양저우", "톨레도", "메카", "파리",
      "크라스노야르스크", "영파", "콜카타", "멤피스", "나주", "대구", "장안", "앙코르", "바티칸", "함부르크",
      "남양주", "톈진", "카트만두", "베네치아", "논산", "충칭", "키이우", "보스턴", "페르세폴리스", "항저우",
      "오키나와", "당진", "사라예보", "서울", "상트페테르부르크", "대마도", "아바나", "상주", "베를린", "울산",
      "아헨", "원산", "악숨", "서천", "에든버러", "영주", "예루살렘", "인천", "울룬디", "영흥",
      "워싱턴 D.C.", "오사카", "음반자콩구", "진주", "제네바", "캄차카반도", "카르타고", "곡산", "캔버라", "의령",
      "상하이", "천안", "가오", "평양", "쿠스코", "광주", "테노치티틀란", "뉴델리", "오시비엥침", "부산"
    ];

    const specialCities = {
      "수마트라": "비상! 대지진 발생!\n세계에서 가장 추운 전쟁은?",
      "오키나와": "비상! 지진 발생!\n세상에서 가장 가난한 왕은?",
      "우한": "비상! 코로나-19 창궐!\n신하가 왕에게 공을 던지면서 하는 말은?",
      "자카르타": "비상! 홍수 발생!\n일본 뱀이 한국 뱀을 이길 수 없는 이유는?",
      "히로시마": "비상! 하늘에서 핵폭탄이 떨어졌다!\n싸움을 잘하는 오리는?",
      "캄차카반도": "비상! 화산 폭발!\n넌센스 문제!\n조선의 왕 중 가장 계산을 잘한 왕은?",
      "사라예보": "탕!\n넌센스 문제!\n조선의 왕 중 가장 숫자를 못 세는 왕은?",
      "오시비엥침": "저기서 군인들이!\n신사가 하는 인사는?",
      "크라스노야르스크": "비상! 퉁구스카 대폭발!\n여명 학생회는 몇 대 학생회인가요?",
      "함부르크": "비상! 콜레라 창궐!\n우리나라에서 대통령이 된 사람은 총 몇 명인가요?"
    };

    const startPositionsIndexes = [0, 9, 90, 99];
    const startPositions = startPositionsIndexes.map(i => cities[i]);

    const fixedQuestions = {
      하: cities.reduce((acc, city, i) => {
        if(city) acc[city] = `${city} 하 난이도 문제 예시 ${i + 1}`;
        return acc;
      }, {}),
      중: cities.reduce((acc, city, i) => {
        if(city) acc[city] = `${city} 중 난이도 문제 예시 ${i + 1}`;
        return acc;
      }, {})
    };

    const hardQuestions = [
      "상 난이도 문제 예시 1",
      "상 난이도 문제 예시 2",
      "상 난이도 문제 예시 3",
      "상 난이도 문제 예시 4",
      "상 난이도 문제 예시 5"
    ];

   function openDifficultyPopup(city) {
  selectedCity = city;

  const difficultys= ["하", "중", "상"];
  difficultys.forEach((difficulty, index) => {
    const button = document.querySelector(`#difficultyPopup button:nth-child(${index + 2})`);
    const key = `${city}-${difficulty}`;
    if (usedQuestions[key]) {
      button.disabled = true;
      button.style.backgroundColor = "#ccc";
      button.style.cursor = "not-allowed";
      button.style.color = "#666";
    } else {
      button.disabled = false;

      // 원래 스타일 복원
      if (difficulty === "하") {
        button.style.backgroundColor = "#28a745"; // 기본
        button.style.color = "white";
      } else if (difficulty === "중") {
        button.style.backgroundColor = "#007bff";
        button.style.color = "white";
      } else if (difficulty === "상") {
        button.style.backgroundColor = "#dc3545";
        button.style.color = "white";
      }
      button.style.cursor = "pointer";
    }
  });

  document.getElementById("difficultyPopup").style.display = "block";
}

    function selectDifficulty(difficulty) {
  selectedDifficulty = difficulty;    // 난이도 저장
  document.getElementById("difficultyPopup").style.display = "none";

    if (specialCities[selectedCity]) {
    currentQuestion = { city: selectedCity, isSpecial: true };
    showQuestion(currentQuestion);
    return; // 🔥 일반 도시 로직 타지 않도록 return
  }

  const key = `${selectedCity}-${difficulty}`;
  if (usedQuestions[key]) {
    alert("이미 푼 문제입니다!");
    return;
  }
  usedQuestions[key] = true;  // 사용 기록 저장

  currentQuestion = "";

 if (difficulty === "상") {
    // 도시 없이 상 난이도 문제만 모으기
    const hardQuestions = questionsFromSheet.filter(
      q => q.difficulty === "상"
    );

    if (hardQuestions.length > 0) {
      // 랜덤으로 하나 뽑기
      currentQuestion = hardQuestions[Math.floor(Math.random() * hardQuestions.length)];
    } else {
      alert("상 난이도 문제가 없습니다!");
      return;
    }

  } else {
    // 하/중 난이도는 도시+난이도 일치해야 함
    currentQuestion = questionsFromSheet.find(q => {
   return q.city?.trim() === selectedCity?.trim() &&
          q.difficulty?.trim() === difficulty?.trim();
});
  }

  if (!currentQuestion) {
    console.warn("해당 도시/난이도의 문제 없음:", { city: selectedCity, difficulty: difficulty });
    alert("문제가 존재하지 않습니다!");
    return;
  }

  console.log("선택된 문제:", currentQuestion);
  showQuestion(currentQuestion);
}

console.log("검색 직전:", selectedCity, selectedDifficulty);
console.log("데이터 샘플:", questionsFromSheet[0]);

function getRandomHardQuestion() {
    // 전체 상 난이도 문제 중 사용하지 않은 것만 필터링
    const hardQuestions = questionsFromSheet.filter(q => currentQuestion.difficulty === "상");
  const unused = hardQuestions.filter(q => !usedHardQuestions.includes(currentQuestion.question));
    
    if (unusedHardQuestions.length === 0) {
        alert("모든 상 난이도 문제가 다 소진되었습니다!");
        return null; // 더 이상 뽑을 문제가 없음
    }

     const rand = unused[Math.floor(Math.random() * unused.length)];
     usedHardQuestions.push(rand.question); // 질문 텍스트로 기록
     return rand;

    // 랜덤으로 선택
    const randomIndex = Math.floor(Math.random() * unusedHardQuestions.length);
    const question = unusedHardQuestions[randomIndex];

    // 사용 기록에 추가
    usedHardQuestions.push(question.id);

    return question;
}

function resetQuestionUI() {
  // 이전 문제 정답 숨기기
    const answerDisplay = document.getElementById("answerDisplay");
    if (answerDisplay) answerDisplay.style.display = "none";
    answerDisplay.textContent = "";
    
    document.getElementById("questionText").textContent = "";
    document.getElementById("questionText").style.display = "none";

    document.getElementById("resourceBox").style.display = "none";
    document.getElementById("questionResource").textContent = "";
    document.getElementById("questionSource").textContent = "";

    document.getElementById("choicesContainer").style.display = "none";

    document.getElementById("answerDisplay").style.display = "none";

    document.getElementById("specialText").textContent = "";
    document.getElementById("specialText").style.display = "none";

    document.getElementById("questionPopup").style.display = "none";
}

function selectCity(cityName) {
    resetQuestionUI();  // 기존 문제/스페셜텍스트 초기화

    selectedCity = cityName;

    if (specialCities[cityName]) {
        // 🔥 스페셜 도시 로직
        const specialTextEl = document.getElementById("specialText");
        specialTextEl.textContent = specialCities[cityName];
        specialTextEl.style.display = "block";

        currentQuestion = { city: cityName, isSpecial: true };

        document.getElementById("questionPopup").style.display = "block";
        return;
    } else {
        // 🔥 일반 도시 로직
        const difficulty = selectedDifficulty || "하"; // 난이도 기본값
        const question = questionsFromSheet.find(q => 
            q.city?.trim() === cityName?.trim() && q.difficulty?.trim() === difficulty
        );

        if (!question) {
            alert("문제가 존재하지 않습니다!");
            return;
        }

        currentQuestion = question;
        showQuestion(currentQuestion);
    }
}

function showQuestion(currentQuestion) {
    resetQuestionUI(); // 여기서도 초기화 반복

    if (currentQuestion.isSpecial) {
        const specialTextEl = document.getElementById("specialText");
        specialTextEl.textContent = specialCities[currentQuestion.city];
        specialTextEl.style.display = "block";
        document.getElementById("questionPopup").style.display = "block";
        return;
    }

    let questionText = (currentQuestion.question || "")
    .replace(/\r\n/g, "\n")      // 윈도우 줄바꿈 통일
    .split("\n")                  // 줄 단위로 분리
    .map(line => line.trim())     // 각 줄 앞뒤 공백 제거
    .filter(line => line !== "")  // 빈 줄 제거
    .join("\n");                  // 다시 합치기

    // 일반 도시 문제 UI
    document.getElementById("questionText").textContent = cleanQuestionText(currentQuestion.question);
    document.getElementById("questionText").style.display = "block";

    const resourceBox = document.getElementById("resourceBox");
    const hasResource = currentQuestion.resource && currentQuestion.resource.trim() !== "";
    const hasSource = currentQuestion.source && currentQuestion.source.trim() !== "";

    if (hasResource || hasSource) {
        resourceBox.style.display = "block";
        document.getElementById("questionResource").textContent = hasResource ? currentQuestion.resource : "";
        document.getElementById("questionSource").textContent = hasSource ? currentQuestion.source :"";
    } else {
        resourceBox.style.display = "none";
    }

    const choices = [currentQuestion.choice1, currentQuestion.choice2, currentQuestion.choice3, currentQuestion.choice4];
    const hasChoices = choices.some(c => c && c.trim() !== "");

    if (hasChoices) {
        const choicesContainer = document.getElementById("choicesContainer");
        choicesContainer.style.display = "grid";
        choices.forEach((c, i) => {
            const btn = document.getElementById("choice" + (i + 1));
            if (c && c.trim() !== "") {
                btn.style.display = "inline-block";
                btn.textContent = c;
            } else {
                btn.style.display = "none";
            }
        });
    }

    // ✅ 정답 확인 버튼 보이기
    const showAnswerBtn = document.getElementById("showAnswerBtn");
showAnswerBtn.style.display = "inline-block";
showAnswerBtn.onclick = () => {
    const fullscreenAnswer = document.getElementById("fullscreenAnswer");
    fullscreenAnswer.textContent = currentQuestion.answer || "정답 없음";
    fullscreenAnswer.style.display = "flex"; // 화면 전체에 표시

    // 2초 후 자동 숨김
    setTimeout(() => {
        fullscreenAnswer.style.display = "none";
    }, 2000);
};

    document.getElementById("questionPopup").style.display = "block";
}

// 정답 / 오답 버튼
// 정답/오답 버튼 클릭 처리
function handleAnswer(isCorrect) {
  const fullscreenAnswer = document.getElementById("fullscreenAnswer");

  if (isCorrect) {
    fullscreenAnswer.innerText = "정답!";
    fullscreenAnswer.style.display = "flex"; // 중앙 정렬 위해 flex

    // 점수 추가 (난이도에 따라 점수 계산)
    let scoreToAdd = 0;
    if (selectedDifficulty === "하") scoreToAdd = 1;
    if (selectedDifficulty === "중") scoreToAdd = 2;
    if (selectedDifficulty === "상") scoreToAdd = 3;

        // 점수 저장
    playerscores[players[currentPlayer]] += scoreToAdd;

    // 도시 색칠 (하/중 문제)
    document.querySelectorAll(".cell").forEach(cell => {
      if (cell.textContent.trim() === selectedCity) {
        cell.style.backgroundColor = playerColors[currentPlayer];
        cell.style.color = "white";
        cell.style.fontWeight = "bold";
      }
    });
    // 점수판 갱신
    updateScoreTable();
  } else {
    fullscreenAnswer.innerText = "오답!";
  }

  // 정답/오답 화면 표시
  fullscreenAnswer.style.display = "flex";

    setTimeout(() => {
    fullscreenAnswer.style.display = "none";
    document.getElementById("questionPopup").style.display = "none";

    // 턴 넘기기
    currentPlayer = (currentPlayer + 1) % players.length;
    updateTurnDisplay();
  }, 1500);
}

 function answerQuestion(correct) {
  document.getElementById("questionPopup").style.display = "none";

  if (correct) {
    const correctSound = document.getElementById("correctSound");
    correctSound.play().catch(()=>{});

    let points = 0;
    if (selectedDifficulty === "하") points = 1;
    else if (selectedDifficulty === "중") points = 2;
    else if (selectedDifficulty === "상") points = 3;

    playerscores[currentPlayer] += points;

    // 해당 도시 색칠
    document.querySelectorAll(".cell").forEach(cell => {
      if (cell.textContent.trim() === selectedCity) {
        cell.style.backgroundColor = playerColors[currentPlayer];
        cell.style.color = "white";
        cell.style.fontWeight = "bold";
      }
    });

    updateScoreTable();
  } else {
    const wrongSound = document.getElementById("wrongSound");
    wrongSound.play().catch(()=>{});
  }

  // 턴 넘기기
  currentPlayer = (currentPlayer + 1) % players.length;
  updateTurnDisplay();
}

    const playerscores = {};

  // ===== 난이도 선택 후 문제 보여주기 =====

    function startGame() {
   document.getElementById("startScreen").style.display = "none"; 

   const inputs = document.querySelectorAll(".playerName");
  players.length = 0; 
  inputs.forEach(input => {
    const name = input.value.trim();
    if (name) players.push(name);
  });

  if (players.length < 1) {
    alert("최소 1명의 플레이어가 필요합니다!");
    return;
  }

// playerscores 초기화
      for (const key in playerscores) delete playerscores[key];
      players.forEach(p => {
        playerscores[p] = 0;
        currentPlayer = 0;
      });

  // 게임 화면 표시
  document.getElementById("gameContainer").style.display = "flex";
  document.getElementById("scorePanel").classList.add("show"); // 점수판 보이기

  drawBoard();
  updateTurnDisplay();
  updateScoreTable();

  // 배경 변경
  document.body.style.backgroundImage = "none";
  document.body.style.backgroundColor = "black";

      // 효과음 재생
const startSound = document.getElementById("startSound");
startSound.play().catch(err => {
  console.log("시작 효과음 재생 실패:", err);
});
    }

function showSpecialEvent(city) {
    selectedCity = city;
    selectedDifficulty = "하"; // 점수를 위해 난이도는 하로 고정

    resetQuestionUI(); // 🔥 추가: 이전 일반 문제 UI 초기화

    // 특수 텍스트 표시
    const specialTextEl = document.getElementById("specialText");
    specialTextEl.textContent = specialCities[city];
    specialTextEl.style.display = "block";

    document.getElementById("questionPopup").style.display = "block";

    // 🎵 특수 효과음 재생
    const specialSound = document.getElementById("specialSound");
    specialSound.play().catch(err => console.log(err));
}

function answerMultipleChoice(choiceIndex) {
  const selectedBtn = document.getElementById(`choice${choiceIndex+1}`);
  const selectedText = selectedBtn.textContent;

  const correct = selectedText === currentQuestion.answer;

  answerQuestion(correct); // 기존 answerQuestion 재사용  
}

function cleanQuestionText(text) {
    if (!text) return "";

    // 1. 윈도우 줄바꿈 통일
    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

    // 2. 연속된 빈 줄 제거 (3줄 이상 → 1줄만 남김)
    text = text.replace(/\n{2,}/g, "\n");

    // 3. 각 줄 앞뒤 공백 제거
    text = text.split("\n").map(line => line.trim()).join("\n");

    // 4. 맨 앞뒤 공백 제거
    text = text.trim();

    return text;
}

function drawBoard() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      cities.forEach((city, idx) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = city;
        cell.onclick = () => {
          if (specialCities[city]) {
            showSpecialEvent(city);
          } else {
            openDifficultyPopup(city);
          }
        };
        const startIndex = startPositions.indexOf(city);
        if (startIndex !== -1 && startIndex < players.length) {
          cell.style.backgroundColor = playerColors[startIndex];
          cell.style.color = "white";
          cell.style.fontWeight = "bold";
        }
        grid.appendChild(cell);
      });
    }

  function updateScoreTable() {
  const headerRow = document.getElementById("scoreHeaderRow");
  const dataRow = document.getElementById("scoreDataRow");

  headerRow.innerHTML = "<th>조명</th>";
  dataRow.innerHTML = "<th>점수</th>";

  players.forEach((player, idx) => {
    headerRow.innerHTML += `<th><span class="colorBox" style="background-color:${playerColors[idx]}"></span>${player}</th>`;
    dataRow.innerHTML += `<td>${playerscores[player]}</td>`;
  });
}

    function updateTurnDisplay() {
      if (players.length > 0) {
        document.getElementById("turnDisplay").textContent = `${players[currentPlayer]}`;
        document.getElementById("turnDisplay").style.color = playerColors[currentPlayer];
      }
    }
    function endGame() {
  // 💥 폭발 효과 실행
  const explosion = document.getElementById("explosionEffect");
  explosion.style.display = "block";
  explosion.style.animation = "explode 1s ease-out";

  // 1초 후 제거
  setTimeout(() => {
    explosion.style.display = "none";
  }, 1000);

  // 순위 계산
  let ranking = [...players];
  ranking.sort((a, b) => playerscores[b] - playerscores[a]);

  let rankingText = "";
  ranking.forEach((player, i) => {
    let fontSize = 36 - i * 4; // 1등: 36px → 2등: 32px ...
    if (fontSize < 16) fontSize = 16;

    let style = `
      font-size: ${fontSize}px;
      font-weight: ${i === 0 ? 'bold' : 'normal'};
      color: ${i === 0 ? '#d9534f' : '#222'};
      margin-bottom: 10px;
      text-align: center;
    `;
    rankingText += `<div style="${style}">${i + 1}위 ${player} - 점수: ${playerscores[player]}</div>`;
  });

  document.getElementById("rankingList").innerHTML = rankingText;
  document.getElementById("rankingPopup").style.display = "block";
}
   
    function closeRankingPopup() {
      document.getElementById("rankingPopup").style.display = "none";
    }

      // ✅ 음악 재생
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.3;     // 볼륨 조절 (0 ~ 1)
  bgm.loop = true;      // 반복 재생
  bgm.play().catch(err => {
    console.log("음악 자동 재생이 차단됨:", err);
  });

    // 조 이름 입력 완료 후 엔터 눌러도 게임 시작 가능
    document.querySelectorAll(".playerName").forEach(input => {
  input.addEventListener("keypress", e => {
    if (e.key === "Enter") {
      startGame();
    }
  });
});

    // 입력칸 6개 중 하나라도 변경되면 플레이어 이름 자동 업데이트
    document.querySelectorAll(".playerName").forEach(input => {
      input.addEventListener("input", () => {
        // 자동으로 플레이어 이름 갱신
        // (추가 구현 가능)
      });
    });

    window.addEventListener("DOMContentLoaded", () => {
  const fullscreenAnswer = document.getElementById("fullscreenAnswer");
  const closeBtn = document.getElementById("questionPopupClose");
    closeBtn.addEventListener("click", () => {
        document.getElementById("questionPopup").style.display = "none";
        resetQuestionUI();
    });
  // 이제 JS 코드 안전하게 사용 가능
});
  </script>
  <div id="explosionEffect" style="display: none;">💥</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</body>
</html>
